<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='WordPress的All-in-One视频库插件存在任意用户的任意文件下载和SSRF的攻击'>
<title>[CVE-2022-2633] WordPress All-in-One插件SSRF&#43;任意文件下载</title>

<link rel='canonical' href='https://blog.huamang.xyz/post/cve-2022-2633/'>

<link rel="stylesheet" href="/scss/style.min.a3acb339192261971279929bada446e8966aa7224703ebfd992d05448daed96b.css"><meta property='og:title' content='[CVE-2022-2633] WordPress All-in-One插件SSRF&#43;任意文件下载'>
<meta property='og:description' content='WordPress的All-in-One视频库插件存在任意用户的任意文件下载和SSRF的攻击'>
<meta property='og:url' content='https://blog.huamang.xyz/post/cve-2022-2633/'>
<meta property='og:site_name' content='Huamang'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2022-11-11T15:04:12&#43;08:00'/><meta property='article:modified_time' content='2022-11-11T15:04:12&#43;08:00'/>
<meta name="twitter:title" content="[CVE-2022-2633] WordPress All-in-One插件SSRF&#43;任意文件下载">
<meta name="twitter:description" content="WordPress的All-in-One视频库插件存在任意用户的任意文件下载和SSRF的攻击">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "dark");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu2c79bb77476a4f0f53420443e9db5bfa_18691_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Huamang</a></h1>
            <h2 class="site-description"></h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/Huamang'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://blog.huamang.xyz/index.xml'
                        target="_blank"
                        title="RSS"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="5" cy="19" r="1" />
  <path d="M4 4a16 16 0 0 1 16 16" />
  <path d="M4 11a9 9 0 0 1 9 9" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com/Huamang7'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/friends/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Friends</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#漏洞简介">漏洞简介</a></li>
    <li><a href="#漏洞分析">漏洞分析</a>
      <ol>
        <li><a href="#环境搭建">环境搭建</a></li>
        <li><a href="#漏洞分析-1">漏洞分析</a>
          <ol>
            <li><a href="#ssrf">SSRF</a></li>
            <li><a href="#任意文件读取">任意文件读取</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#漏洞修复">漏洞修复</a>
      <ol>
        <li><a href="#修复点1">修复点1</a></li>
        <li><a href="#修复点2">修复点2</a></li>
        <li><a href="#修复点3">修复点3</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" style="background-color: #3b58eb; color: #fff;">
                漏洞分析
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/post/cve-2022-2633/">[CVE-2022-2633] WordPress All-in-One插件SSRF&#43;任意文件下载</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            WordPress的All-in-One视频库插件存在任意用户的任意文件下载和SSRF的攻击
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Nov 11, 2022</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 4 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="漏洞简介">漏洞简介</h1>
<p>CVE编号：<a class="link" href="https://nvd.nist.gov/vuln/detail/CVE-2022-2633"  target="_blank" rel="noopener"
    >CVE-2022-2633</a></p>
<p>漏洞描述：WordPress的All-in-One视频库插件存在任意用户的任意文件下载和SSRF的攻击</p>
<p>影响版本：2.5.8~2.6.0</p>
<blockquote>
<p>The All-in-One Video Gallery plugin for WordPress is vulnerable to arbitrary file downloads and blind server-side request forgery via the &lsquo;dl&rsquo; parameter found in the ~/public/video.php file in versions up to, and including 2.6.0. This makes it possible for unauthenticated users to download sensitive files hosted on the affected server and forge requests to the server.</p>
</blockquote>
<h1 id="漏洞分析">漏洞分析</h1>
<h2 id="环境搭建">环境搭建</h2>
<p>首先下载到存在漏洞的版本：https://downloads.wordpress.org/plugin/all-in-one-video-gallery.2.6.0.zip</p>
<p>安装好插件即可</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221111153639984.png"
	
	
	
	loading="lazy"
	
		alt="image-20221111153639984"
	
	
></p>
<h2 id="漏洞分析-1">漏洞分析</h2>
<h3 id="ssrf">SSRF</h3>
<p>通过漏洞描述知道，漏洞存在<code>~/public/video.php</code>中的参数dl中</p>
<p>如果dl不是数字，就会把内容base64解码，存入$file变量，如果文件为空则exit</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221111154125797.png"
	
	
	
	loading="lazy"
	
		alt="image-20221111154125797"
	
	
></p>
<p>然后就是把file中空格给换成20%</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221111154234372.png"
	
	
	
	loading="lazy"
	
		alt="image-20221111154234372"
	
	
></p>
<p>下面的判断逻辑是这样的</p>
<p>首先判断<code>home_url()</code>是否存在，这个函数返回的是WordPress 安装的完整 URL</p>
<p>再判断file是否包含<code>http</code>或者<code>https</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php">		<span class="c1">// Detect the file type	
</span><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span> <span class="nx">strpos</span><span class="p">(</span> <span class="nv">$file</span><span class="p">,</span> <span class="nx">home_url</span><span class="p">()</span> <span class="p">)</span> <span class="o">!==</span> <span class="k">false</span> <span class="p">)</span> <span class="p">{</span>
			<span class="nv">$is_remote_file</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
		<span class="p">}</span>		        		
          
        <span class="k">if</span> <span class="p">(</span> <span class="nx">preg_match</span><span class="p">(</span> <span class="s1">&#39;#http://#&#39;</span><span class="p">,</span> <span class="nv">$file</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">preg_match</span><span class="p">(</span> <span class="s1">&#39;#https://#&#39;</span><span class="p">,</span> <span class="nv">$file</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
          	<span class="nv">$formatted_path</span> <span class="o">=</span> <span class="s1">&#39;url&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          	<span class="nv">$formatted_path</span> <span class="o">=</span> <span class="s1">&#39;filepath&#39;</span><span class="p">;</span>
        <span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="nv">$is_remote_file</span> <span class="p">)</span> <span class="p">{</span>
			<span class="nv">$formatted_path</span> <span class="o">=</span> <span class="s1">&#39;url&#39;</span><span class="p">;</span>
		<span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span> <span class="nv">$formatted_path</span> <span class="o">==</span> <span class="s1">&#39;url&#39;</span> <span class="p">)</span> <span class="p">{</span>
          	<span class="nv">$file_headers</span> <span class="o">=</span> <span class="o">@</span><span class="nx">get_headers</span><span class="p">(</span> <span class="nv">$file</span> <span class="p">);</span>
  
          	<span class="k">if</span> <span class="p">(</span> <span class="nv">$file_headers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HTTP/1.1 404 Not Found&#39;</span> <span class="p">)</span> <span class="p">{</span>
           		<span class="k">die</span><span class="p">(</span> <span class="nx">esc_html__</span><span class="p">(</span> <span class="s1">&#39;File is not readable or not found.&#39;</span><span class="p">,</span> <span class="s1">&#39;all-in-one-video-gallery&#39;</span> <span class="p">)</span> <span class="p">);</span>
           		<span class="k">exit</span><span class="p">;</span>
          	<span class="p">}</span>          
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span> <span class="nv">$formatted_path</span> <span class="o">==</span> <span class="s1">&#39;filepath&#39;</span> <span class="p">)</span> <span class="p">{</span>		
          	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="o">@</span><span class="nx">is_readable</span><span class="p">(</span> <span class="nv">$file</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">die</span><span class="p">(</span> <span class="nx">esc_html__</span><span class="p">(</span> <span class="s1">&#39;File is not readable or not found.&#39;</span><span class="p">,</span> <span class="s1">&#39;all-in-one-video-gallery&#39;</span> <span class="p">)</span> <span class="p">);</span>
               	<span class="k">exit</span><span class="p">;</span>
          	<span class="p">}</span>
        <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果file包含了<code>http</code>或者<code>https</code>，那么这里<code>$formatted_path = 'url'</code></p>
<p>这样下面的判断，$is_remote_file默认为true、formatted_path刚刚被赋值为url</p>
<p>判断就会为true从而进入里面执行<code>curl_exec</code>发起请求</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php">       	<span class="c1">// Fetching File Size Located in Remote Server
</span><span class="c1"></span>       	<span class="k">if</span> <span class="p">(</span> <span class="nv">$is_remote_file</span> <span class="o">&amp;&amp;</span> <span class="nv">$formatted_path</span> <span class="o">==</span> <span class="s1">&#39;url&#39;</span> <span class="p">)</span> <span class="p">{</span>         
          	<span class="nv">$data</span> <span class="o">=</span> <span class="o">@</span><span class="nx">get_headers</span><span class="p">(</span> <span class="nv">$file</span><span class="p">,</span> <span class="k">true</span> <span class="p">);</span>
          
          	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">empty</span><span class="p">(</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
          		<span class="nv">$file_size</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$data</span><span class="p">[</span> <span class="s1">&#39;Content-Length&#39;</span> <span class="p">];</span>          
          	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>               
               	<span class="c1">// If get_headers fails then try to fetch fileSize with curl
</span><span class="c1"></span>               	<span class="nv">$ch</span> <span class="o">=</span> <span class="o">@</span><span class="nx">curl_init</span><span class="p">();</span>

               	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="o">@</span><span class="nx">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_URL</span><span class="p">,</span> <span class="nv">$file</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                 	<span class="o">@</span><span class="nx">curl_close</span><span class="p">(</span> <span class="nv">$ch</span> <span class="p">);</span>
                 	<span class="o">@</span><span class="k">exit</span><span class="p">;</span>
               	<span class="p">}</span>
               
               	<span class="o">@</span><span class="nx">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_NOBODY</span><span class="p">,</span> <span class="k">true</span> <span class="p">);</span>
               	<span class="o">@</span><span class="nx">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="k">true</span> <span class="p">);</span>
               	<span class="o">@</span><span class="nx">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_HEADER</span><span class="p">,</span> <span class="k">true</span> <span class="p">);</span>
               	<span class="o">@</span><span class="nx">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_FOLLOWLOCATION</span><span class="p">,</span> <span class="k">true</span> <span class="p">);</span>
               	<span class="o">@</span><span class="nx">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_MAXREDIRS</span><span class="p">,</span> <span class="mi">3</span> <span class="p">);</span>
               	<span class="o">@</span><span class="nx">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_CONNECTTIMEOUT</span><span class="p">,</span> <span class="mi">10</span> <span class="p">);</span>
               	<span class="o">@</span><span class="nx">curl_exec</span><span class="p">(</span> <span class="nv">$ch</span> <span class="p">);</span>
               
               	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="o">@</span><span class="nx">curl_errno</span><span class="p">(</span> <span class="nv">$ch</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                	<span class="nv">$http_status</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="o">@</span><span class="nx">curl_getinfo</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLINFO_HTTP_CODE</span> <span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="nv">$http_status</span> <span class="o">&gt;=</span> <span class="mi">200</span> <span class="o">&amp;&amp;</span> <span class="nv">$http_status</span> <span class="o">&lt;=</span> <span class="mi">300</span> <span class="p">)</span>
                    	<span class="nv">$file_size</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="o">@</span><span class="nx">curl_getinfo</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLINFO_CONTENT_LENGTH_DOWNLOAD</span> <span class="p">);</span>
               	<span class="p">}</span>

               	<span class="o">@</span><span class="nx">curl_close</span><span class="p">(</span> <span class="nv">$ch</span> <span class="p">);</span>               
          	<span class="p">}</span>          
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>         
		   	<span class="k">if</span> <span class="p">(</span> <span class="nv">$formatted_path</span> <span class="o">==</span> <span class="s1">&#39;url&#39;</span> <span class="p">)</span> <span class="p">{</span>		   
			   <span class="nv">$data</span> <span class="o">=</span> <span class="o">@</span><span class="nx">get_headers</span><span class="p">(</span> <span class="nv">$file</span><span class="p">,</span> <span class="k">true</span> <span class="p">);</span>
			   <span class="nv">$file_size</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">];</span>			   
		   	<span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span> <span class="nv">$formatted_path</span> <span class="o">==</span> <span class="s1">&#39;filepath&#39;</span> <span class="p">)</span> <span class="p">{</span>		   
		       <span class="nv">$file_size</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="o">@</span><span class="nx">filesize</span><span class="p">(</span> <span class="nv">$file</span> <span class="p">);</span>			   			   
		   	<span class="p">}</span>		   
       	<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里测试一个baidu.com，可以看到成功发包</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221111155455177.png"
	
	
	
	loading="lazy"
	
		alt="image-20221111155455177"
	
	
></p>
<h3 id="任意文件读取">任意文件读取</h3>
<p>其实任意文件读取有两条路可以走</p>
<ul>
<li>SSRF打file协议</li>
<li>绕过SSRF</li>
</ul>
<p>file协议这里其实就简单了，换个协议罢了，比如我们写个<code>file:///etc/passwd</code></p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221111160844800.png"
	
	
	
	loading="lazy"
	
		alt="image-20221111160844800"
	
	
></p>
<p>验证成功</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221111160715632.png"
	
	
	
	loading="lazy"
	
		alt="image-20221111160715632"
	
	
></p>
<p>那么绕过SSRF的方法是怎么实现的？</p>
<p>在文件末尾可以看到，这里直接进行文件读取然后直接print出来了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="nv">$nfile</span> <span class="o">=</span> <span class="o">@</span><span class="nx">fopen</span><span class="p">(</span> <span class="nv">$file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span> <span class="p">);</span>
<span class="k">while</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">feof</span><span class="p">(</span> <span class="nv">$nfile</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>                 
    <span class="k">print</span><span class="p">(</span> <span class="o">@</span><span class="nx">fread</span><span class="p">(</span> <span class="nv">$nfile</span><span class="p">,</span> <span class="nv">$chunk</span> <span class="p">)</span> <span class="p">);</span>
    <span class="o">@</span><span class="nx">ob_flush</span><span class="p">();</span>
    <span class="o">@</span><span class="nx">flush</span><span class="p">();</span>
<span class="p">}</span>
<span class="o">@</span><span class="nx">fclose</span><span class="p">(</span> <span class="nv">$filen</span> <span class="p">);</span>		
</code></pre></td></tr></table>
</div>
</div><p>所以为了让程序执行到这里，我们就不能让他在前面被截停，从代码上来就是得绕过这个判断</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="k">if</span> <span class="p">(</span> <span class="nv">$is_remote_file</span> <span class="o">&amp;&amp;</span> <span class="nv">$formatted_path</span> <span class="o">==</span> <span class="s1">&#39;url&#39;</span> <span class="p">)</span> 
</code></pre></td></tr></table>
</div>
</div><p>而<code>$is_remote_file</code>是有一个点可以赋值为false的，只要我们的file里面有wordpress的路径就可以了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="k">if</span> <span class="p">(</span> <span class="nx">strpos</span><span class="p">(</span> <span class="nv">$file</span><span class="p">,</span> <span class="nx">home_url</span><span class="p">()</span> <span class="p">)</span> <span class="o">!==</span> <span class="k">false</span> <span class="p">)</span> <span class="p">{</span>
			<span class="nv">$is_remote_file</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里我传一个</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">file:///http://127.0.0.1/0day/wordpress/wordpress6.1/../../../../../../../etc/passwd
</code></pre></td></tr></table>
</div>
</div><p><code>$is_remote_file</code>成功赋值为false</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221111165235486.png"
	
	
	
	loading="lazy"
	
		alt="image-20221111165235486"
	
	
></p>
<p>成功readfile</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221111165322374.png"
	
	
	
	loading="lazy"
	
		alt="image-20221111165322374"
	
	
></p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221111165447176.png"
	
	
	
	loading="lazy"
	
		alt="image-20221111165447176"
	
	
></p>
<h1 id="漏洞修复">漏洞修复</h1>
<p>下载最新版来compare一下：https://downloads.wordpress.org/plugin/all-in-one-video-gallery.2.6.1.zip</p>
<h2 id="修复点1">修复点1</h2>
<p>变量名换成vdl，base64_decode换成wordpress自带的函数</p>
<p>sanitize_text_field，作用是对用户输入进行过滤</p>
<blockquote>
<p>Check whether the string is a valid UTF-8 character, and remove all HTML tags</p>
</blockquote>
<p>get_transient，用来获取瞬态数据的值，如果瞬态数据不存在、没有值或已过期，则返回值将为false</p>
<blockquote>
<p>If the transient does not exist, does not have a value, or has expired, then the return value will be false.</p>
</blockquote>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221111172038267.png"
	
	
	
	loading="lazy"
	
		alt="image-20221111172038267"
	
	
></p>
<p>这里如果传入我们的SSRF想到达的URL，就会过不了get_transient了</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221111174807777.png"
	
	
	
	loading="lazy"
	
		alt="image-20221111174807777"
	
	
></p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221111174840733.png"
	
	
	
	loading="lazy"
	
		alt="image-20221111174840733"
	
	
></p>
<h2 id="修复点2">修复点2</h2>
<p>formatted_path设置默认值url</p>
<p>并且判断如果不包含<code>http</code>和<code>https</code>的话，会把<code>$is_remote_file</code>设为false</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221111172211070.png"
	
	
	
	loading="lazy"
	
		alt="image-20221111172211070"
	
	
></p>
<h2 id="修复点3">修复点3</h2>
<p>会取出file的文件后缀ext，然后进行判断</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221111172618590.png"
	
	
	
	loading="lazy"
	
		alt="image-20221111172618590"
	
	
></p>
<p>如果不是指定的媒体文件，mime_type会被赋值为application/octet-stream，从而进入判断exit进程</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221111172655265.png"
	
	
	
	loading="lazy"
	
		alt="image-20221111172655265"
	
	
></p>
<p>这里就防止了通过下面的fopen来读取文件了</p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2022 Huamang
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        <span id="busuanzi_container_page_pv"> 阅读量 <span id="busuanzi_value_page_pv"></span> 次 </span>
        <br>
        
        <span class="icp"><a href="https://beian.miit.gov.cn/" target="_blank">赣ICP备2021001334号</a></span>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
    </body>
</html>
